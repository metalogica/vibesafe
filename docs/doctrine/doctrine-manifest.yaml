# Doctrine Manifest
# Version: 1.1.0
#
# This manifest enables architect agents to select relevant doctrines
# based on brief content without preloading all documentation.
#
# Usage:
#   1. Agent scans brief for trigger keywords
#   2. Matches triggers → identifies relevant doctrines
#   3. Decides: self-load (1-2 docs) OR spawn specialists (3+)

doctrines:
  - id: db
    name: Database Doctrine
    triggers:
      - database
      - schema
      - Convex
      - convex
      - table
      - index
      - defineTable
      - defineSchema
      - query
      - mutation
      - internalMutation
      - internalQuery
      - scheduler
      - audit_events
    summary: >
      Convex schema with defineSchema/defineTable, v.id() for foreign keys,
      indexes for all query patterns, queries/mutations/actions separation,
      internal functions for service-to-service calls, real-time by default.
      Audit lifecycle: pending → fetching → analyzing → evaluating → complete/failed.
      Mutations schedule actions via ctx.scheduler.runAfter.
    path: docs/doctrine/architecture/db/database-doctrine.md
    specialist: db-architect

  - id: server
    name: Server Doctrine
    triggers:
      - Convex action
      - action
      - client
      - API
      - external API
      - GitHub
      - Claude
      - Anthropic
      - fetch
      - Zod
      - validation
      - audit service
      - orchestration
      - ingestion
      - sanitize
      - rate limit
      - FMEA
      - budget
    summary: >
      Convex Actions for external API calls (GitHub REST, Anthropic Messages API),
      structured result returns ({ success, data } | { success, error }), Zod validation
      on all external responses, clients never throw exceptions. FMEA mitigations:
      action wall-clock budget, normalizeGitHubError, post-Zod sanitization layer.
      Unified startAuditAction handles ingest + analyze + evaluate.
    path: docs/doctrine/architecture/server/server-doctrine.md
    specialist: server-architect

  - id: domain
    name: Domain Logic Doctrine
    triggers:
      - entity
      - aggregate
      - factory
      - Result
      - DomainError
      - pure function
      - invariant
      - validation
      - domain
      - evaluator
      - fileFilter
      - tokenEstimator
      - parseGitHubUrl
      - sanitize
    summary: >
      Lightweight domain layer in src/domain/audit/ for shared pure functions
      (URL parsing, file filtering, token estimation, safety scoring, sanitization).
      No DDD entities/factories — Convex schema is source of truth for types.
      Extract to domain when shared, complex, or safety-critical.
    path: docs/doctrine/architecture/domain/domain-doctrine.md
    specialist: domain-architect

  - id: frontend
    name: Frontend Doctrine
    triggers:
      - component
      - hook
      - UI
      - skeleton
      - React
      - useQuery
      - useMutation
      - realtime
      - subscription
      - mapper
      - view model
      - AgentFeed
      - VulnerabilitiesPanel
    summary: >
      Flat component structure, Convex useQuery/useMutation for real-time state,
      mapper functions (Doc → view model) in src/frontend/lib/, derived state via
      useMemo, conditional queries with 'skip', create+schedule mutation pattern.
    path: docs/doctrine/architecture/frontend/frontend-doctrine.md
    specialist: frontend-architect

  - id: style-math
    name: Mathematical Style
    triggers:
      - AMM
      - LMSR
      - pricing
      - cost function
      - Decimal
      - mathematical
      - logSumExp
      - numerical stability
    summary: >
      Chained expressions mirroring equations, cite papers not code mechanics,
      Decimal end-to-end, tests assert invariants not scenarios.
    path: docs/doctrine/architecture/style/a-math-programming-style.md
    specialist: domain-architect  # Math style is subset of domain

  - id: style-business
    name: Business Logic Style
    triggers:
      - service
      - orchestration
      - workflow
      - use case
      - Clean Code
    summary: >
      Small functions, intention-revealing names, explicit control flow,
      temporary variables for readability, object parameters with destructuring.
    path: docs/doctrine/architecture/style/b-business-logic-programming-style.md
    specialist: null  # General guidance, no specialist needed

# ------------------------------------------------------------------------------
# FMEA Footnote: Known Risks & Future Improvements
# ------------------------------------------------------------------------------
#
# This manifest uses keyword triggers for doctrine selection. A formal FMEA
# identified the following risks that are ACCEPTED for v1.0 but should be
# addressed when scaling this system:
#
# | Rank | Failure Mode                | RPN | Mitigation (Future)                          |
# |------|-----------------------------| ----|----------------------------------------------|
# | 1    | Integration seam violations | 350 | Add adversary phase with seam checklist      |
# | 2    | Wrong doctrine selected     | 270 | Replace triggers with impact-surface taxonomy|
# | 3    | Complexity mis-estimation   | 270 | Formal scoring model for spawn decisions     |
# | 4    | Doctrine drift              | 252 | Version pinning + content hash validation    |
#
# Next Steps (v2.0):
#   1. Define impact surfaces: PERSISTENCE, AUTH, FINANCIAL, MUTATION, PUBLIC_EXPOSURE
#   2. Create integration-seams.md defining cross-boundary contracts
#   3. Add complexity scoring to brief template
#   4. Generate doctrine hashes and validate before loading
#   5. Record doctrine versions in spec output for audit trail
#
# Reference: Session transcript 2026-02-11, FMEA analysis
# ------------------------------------------------------------------------------
