import React from 'react';
import { X, Copy, Check, FileCode, AlertTriangle, AlertOctagon, Info, CheckCircle2, XCircle, Activity } from 'lucide-react';
import { motion, AnimatePresence } from 'motion/react';
import { Vulnerability } from './VulnerabilitiesPanel';

interface VulnerabilityModalProps {
  vulnerability: Vulnerability | null;
  isOpen: boolean;
  onClose: () => void;
}

export const VulnerabilityModal: React.FC<VulnerabilityModalProps> = ({
  vulnerability,
  isOpen,
  onClose,
}) => {
  const [copied, setCopied] = React.useState(false);

  React.useEffect(() => {
    if (isOpen) setCopied(false);
  }, [isOpen]);

  const handleCopy = () => {
    if (vulnerability?.fix) {
      navigator.clipboard.writeText(vulnerability.fix);
      setCopied(true);
      setTimeout(() => setCopied(false), 2000);
    }
  };

  const getSeverityColor = (severity: string) => {
    switch (severity) {
      case 'critical': return 'text-red-400 bg-red-400/10 border-red-400/20';
      case 'high': return 'text-orange-400 bg-orange-400/10 border-orange-400/20';
      case 'medium': return 'text-yellow-400 bg-yellow-400/10 border-yellow-400/20';
      case 'low': return 'text-blue-400 bg-blue-400/10 border-blue-400/20';
      default: return 'text-gray-400 bg-gray-400/10 border-gray-400/20';
    }
  };

  const getSeverityIcon = (severity: string) => {
    switch (severity) {
      case 'critical': return <AlertOctagon className="w-5 h-5" />;
      case 'high': return <AlertTriangle className="w-5 h-5" />;
      case 'medium': return <AlertTriangle className="w-5 h-5" />;
      case 'low': return <Info className="w-5 h-5" />;
      default: return <Info className="w-5 h-5" />;
    }
  };

  if (!vulnerability) return null;

  return (
    <AnimatePresence>
      {isOpen && (
        <>
          <motion.div
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            exit={{ opacity: 0 }}
            onClick={onClose}
            className="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4"
          >
            <motion.div
              initial={{ opacity: 0, scale: 0.95, y: 20 }}
              animate={{ opacity: 1, scale: 1, y: 0 }}
              exit={{ opacity: 0, scale: 0.95, y: 20 }}
              onClick={(e) => e.stopPropagation()}
              className="bg-[#0F1620] border border-[#1C2430] w-full max-w-3xl rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]"
            >
              {/* Header */}
              <div className="px-6 py-5 border-b border-[#1C2430] flex items-start justify-between bg-[#0B0F14]">
                <div className="flex items-start gap-4">
                  <div className={`p-2.5 rounded-lg ${getSeverityColor(vulnerability.severity)} bg-opacity-10 mt-1`}>
                    {getSeverityIcon(vulnerability.severity)}
                  </div>
                  <div>
                    <h2 className="text-xl font-bold text-[#E6EEF8] mb-1.5 leading-tight">
                      {vulnerability.title}
                    </h2>
                    <div className="flex items-center gap-3 flex-wrap">
                      <span className={`px-2 py-0.5 rounded text-xs font-bold uppercase tracking-wider border ${getSeverityColor(vulnerability.severity)}`}>
                        {vulnerability.severity}
                      </span>
                      <span className="text-[#8FA3B8] text-sm font-mono flex items-center gap-1.5">
                        <FileCode className="w-3.5 h-3.5" />
                        {vulnerability.file}
                      </span>
                      <span className="text-[#8FA3B8] text-sm font-mono border-l border-[#1C2430] pl-3">
                        {vulnerability.id}
                      </span>
                      {vulnerability.status === 'fixed' ? (
                        <span className="flex items-center gap-1 text-emerald-400 text-xs font-medium px-2 py-0.5 bg-emerald-400/10 rounded border border-emerald-400/20">
                          <CheckCircle2 className="w-3 h-3" /> Fixed
                        </span>
                      ) : (
                        <span className="flex items-center gap-1 text-red-400 text-xs font-medium px-2 py-0.5 bg-red-400/10 rounded border border-red-400/20">
                          <XCircle className="w-3 h-3" /> Open
                        </span>
                      )}
                    </div>
                  </div>
                </div>
                <button
                  onClick={onClose}
                  className="text-[#8FA3B8] hover:text-[#E6EEF8] p-2 hover:bg-[#1C2430] rounded-lg transition-colors"
                >
                  <X className="w-6 h-6" />
                </button>
              </div>

              {/* Body */}
              <div className="p-6 overflow-y-auto space-y-8">
                
                {/* Description */}
                <div className="space-y-2">
                  <h3 className="text-xs font-bold text-[#8FA3B8] uppercase tracking-wider flex items-center gap-2">
                    <Info className="w-3.5 h-3.5" />
                    Description
                  </h3>
                  <p className="text-[#E6EEF8] leading-relaxed text-base bg-[#131B26]/50 p-4 rounded-lg border border-[#1C2430]">
                    {vulnerability.description}
                  </p>
                </div>

                {/* Impact */}
                <div className="space-y-2">
                  <h3 className="text-xs font-bold text-[#8FA3B8] uppercase tracking-wider flex items-center gap-2">
                    <Activity className="w-3.5 h-3.5" />
                    Business & Security Impact
                  </h3>
                  <p className="text-[#E6EEF8] leading-relaxed text-base bg-[#131B26]/50 p-4 rounded-lg border border-[#1C2430]">
                    {vulnerability.impact}
                  </p>
                </div>

                {/* Fix Recommendation */}
                <div className="space-y-2">
                  <div className="flex items-center justify-between">
                    <h3 className="text-xs font-bold text-[#8FA3B8] uppercase tracking-wider flex items-center gap-2">
                      <CheckCircle2 className="w-3.5 h-3.5" />
                      Remediation Plan
                    </h3>
                    <button
                      onClick={handleCopy}
                      className="flex items-center gap-1.5 text-xs font-medium text-[#4DA3FF] hover:text-[#3b82f6] transition-colors"
                    >
                      {copied ? <Check className="w-3 h-3" /> : <Copy className="w-3 h-3" />}
                      {copied ? 'Copied!' : 'Copy Instructions'}
                    </button>
                  </div>
                  <div className="relative group">
                    <div className="bg-[#0B0F14] border border-[#1C2430] rounded-lg p-4 overflow-x-auto">
                      <pre className="text-sm font-mono text-[#E6EEF8]/90 whitespace-pre-wrap">
                        {vulnerability.fix}
                      </pre>
                    </div>
                  </div>
                </div>

                {/* Metadata Footer */}
                <div className="grid grid-cols-2 gap-4 pt-6 border-t border-[#1C2430]">
                  <div>
                    <span className="text-xs text-[#8FA3B8] block mb-1">Detected In Commit</span>
                    <div className="flex items-center gap-2 text-[#E6EEF8] font-mono text-sm">
                      <FileCode className="w-4 h-4 text-[#4DA3FF]" />
                      {vulnerability.commitDetected}
                    </div>
                  </div>
                  <div>
                    <span className="text-xs text-[#8FA3B8] block mb-1">Detection Engine</span>
                    <div className="text-[#E6EEF8] text-sm">
                      VibeSec Multi-Agent Core
                    </div>
                  </div>
                </div>

              </div>
            </motion.div>
          </motion.div>
        </>
      )}
    </AnimatePresence>
  );
};
